# 시뮬레이션 정확도 테스트

## 목적

실제 포켓몬 배틀 결과와 SimplifiedBattleEngine의 시뮬레이션 예측을 비교하여 정확도를 정량적으로 측정합니다.

## 가설

**"초기 턴일수록 시뮬레이션 오차가 크다"**

- 초기 턴: 불확실성이 높음 (기술 선택, 명중 판정, 급소 등)
- 후반 턴: 상황이 단순화되어 예측이 더 정확함

## 측정 지표

### 1. HP Fraction Error

- **정의**: 실제 HP 비율과 예측 HP 비율의 차이
- **범위**: 0.0 ~ 2.0 (0에 가까울수록 정확)
- **계산**: `|실제_HP/최대_HP - 예측_HP/최대_HP|`

### 2. MAE (Mean Absolute Error)

- **정의**: 절대 오차의 평균
- **단위**: HP 값

### 3. 표준편차

- **정의**: 예측의 분산 정도
- **의미**: 낮을수록 일관된 예측

## 파일 구조

```
test/
├── test_simulation_accuracy.py  # 메인 테스트 파일
└── README.md                     # 이 파일
```

## 사용 방법

### 실행

```bash
cd poke-env/sim/test
python test_simulation_accuracy.py
```

### 주요 클래스

#### 1. BattleRecorder

- **역할**: 배틀 진행 중 각 턴의 상태를 스냅샷으로 저장
- **저장 정보**:
  - 턴 번호
  - SimplifiedBattle 객체
  - 플레이어/상대 HP
  - 살아있는 포켓몬 수

#### 2. SimulationAccuracyTester

- **역할**: 스냅샷을 기반으로 시뮬레이션 실행 및 오차 계산
- **주요 메서드**:
  - `test_single_battle()`: 단일 배틀 테스트
  - `analyze_results()`: 전체 결과 분석

## 출력 예시

```
======================================================================
시뮬레이션 정확도 분석 결과
======================================================================

총 배틀 수: 5
총 턴 수: 47

--- 턴별 평균 오차 (HP Fraction Error) ---
턴    평균 오차      표준편차      샘플 수
----------------------------------------------------------------------
1     0.3542       0.1234       5
2     0.3201       0.1156       5
3     0.2987       0.1089       5
4     0.2543       0.0987       5
5     0.2198       0.0891       5

--- 초기 턴 vs 후반 턴 비교 ---
초기 턴 (1~3턴) 평균 오차: 0.3243 ± 0.1159
후반 턴 (4턴~) 평균 오차: 0.2371 ± 0.0939

✓ 가설 검증: 초기 턴일수록 오차가 큽니다.

--- 전체 통계 ---
평균 오차: 0.2807
표준편차: 0.1074
최소 오차: 0.0123
최대 오차: 0.6543
중앙값: 0.2654

======================================================================
```

## 테스트 시나리오

### 1. 기본 테스트

- **배틀 수**: 5개
- **시뮬레이션 횟수**: 각 턴당 50회
- **목적**: 기본 정확도 측정

### 2. 대규모 테스트

- **배틀 수**: 20개
- **시뮬레이션 횟수**: 각 턴당 100회
- **목적**: 통계적 유의성 확보

### 3. 특정 상황 테스트

- **조건**: 특정 포켓몬, 특정 기술
- **목적**: 특수 케이스 검증

## 개선 방향

### 현재 한계

1. **랜덤 시뮬레이션**: 완전히 랜덤한 기술 선택
2. **단순 데미지 계산**: 일부 보정만 구현
3. **교체 미구현**: 기절 시 자동 교체 없음

### 향후 개선

1. **MCTS 통합**: 더 똑똑한 기술 선택
2. **완전한 데미지 계산**: 모든 보정 구현
3. **교체 전략**: 기절 시 최적 교체
4. **상대 정보 추론**: 불완전 정보 처리

## 결과 해석

### 오차가 큰 경우

- 급소 발동
- 예상치 못한 기술 선택
- 추가 효과 발동 (상태이상, 능력치 변화)

### 오차가 작은 경우

- 단순한 공격 기술
- 확정 데미지
- 변화 기술

## 활용

### MCTS에서의 활용

- **시뮬레이션 신뢰도**: 오차가 작을수록 시뮬레이션 신뢰 가능
- **탐색 깊이 조절**: 초기 턴은 얕게, 후반 턴은 깊게 탐색
- **보상 함수 설계**: 오차를 고려한 불확실성 반영

### 디버깅

- **데미지 계산 검증**: 실제 결과와 비교
- **보정 로직 확인**: 특정 보정이 올바르게 적용되는지 확인
- **엣지 케이스 발견**: 예상치 못한 상황 발견

---

**작성일**: 2025-11-10  
**버전**: 1.0.0
